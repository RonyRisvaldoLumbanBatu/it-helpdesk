name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "feat/*", "feature/*" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # 1. Cek Kualitas Kode (Cepat)
  code-quality:
    name: üîç Code Quality
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: pdo, pdo_mysql

    - name: PHP Syntax Check (Lint)
      run: find . -name "*.php" ! -path "./vendor/*" -print0 | xargs -0 -n1 php -l

  # 2. Cek Docker Build & Smoke Test (Memastikan aplikasi jalan di container)
  docker-validation:
    name: üê≥ Docker Check
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
    - uses: actions/checkout@v3

    - name: Build Docker Image
      run: docker build -t it-helpdesk .

    - name: Run Container (Smoke Test)
      run: |
        docker run -d -p 8080:80 --name app-test \
          -e DB_HOST=127.0.0.1 \
          -e DB_NAME=test \
          -e DB_USER=root \
          -e DB_PASS=root \
          it-helpdesk
        sleep 5

    - name: Verify Web Server is Running
      run: |
        curl -I http://localhost:8080 || (docker logs app-test && exit 1)
